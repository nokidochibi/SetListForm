<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>aiko ã‚»ãƒˆãƒªæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #fce4ec;
      color: #444;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h1 {
      color: #d81b60;
      text-align: center;
      font-size: 42px;
      border-bottom: 3px solid #f06292;
      padding-bottom: 15px;
      margin-top: 0;
    }
    .section { margin-bottom: 40px; }
    .section-title {
      font-size: 40px;
      font-weight: bold;
      color: #c2185b;
      margin-bottom: 20px;
    }
    select, input[type="file"], input[type="text"] {
      padding: 18px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #fafafa;
      font-size: 35px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
    .live-details {
      background-color: #f9f9f9;
      border: 1px dashed #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      margin-top: -5px;
      font-size: 32px;
      color: #555;
    }
    #setlist-container {
      counter-reset: song-counter;
      padding-left: 60px;
    }
    .song-entry {
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
      background-color: #fff9fa;
      position: relative;
    }
    .song-entry::before {
      counter-increment: song-counter;
      content: counter(song-counter);
      position: absolute;
      left: -60px;
      top: 25px;
      font-size: 35px;
      font-weight: bold;
      color: #c2185b;
      background-color: #fce4ec;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      line-height: 50px;
      text-align: center;
    }
    .checkbox-group { margin-top: 20px; }
    .checkbox-group label {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      width: auto;
      margin-bottom: 10px;
      font-weight: normal;
      font-size: 35px;
    }
    input[type="checkbox"] {
      transform: scale(2.0);
      margin-left: 20px;
    }
    .radio-group {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }
    .radio-group .radio-group-title {
      font-size: 35px;
      font-weight: normal;
      margin-right: 15px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      margin-right: 15px;
      font-size: 35px;
      margin-bottom: 10px;
    }
    input[type="radio"] {
      appearance: none;
      -webkit-appearance: none;
      width: 32px;
      height: 32px;
      border: 4px solid #c2185b;
      border-radius: 50%;
      background-clip: content-box;
      padding: 6px;
      margin-right: 10px;
      transition: background-color 0.2s;
    }
    input[type="radio"]:checked { background-color: #c2185b; }
    .btn {
      padding: 20px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 35px;
      font-weight: bold;
      transition: background-color 0.3s;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    .btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .btn-primary { background-color: #d81b60; color: white; }
    .btn-secondary { background-color: #757575; color: white; }
    .btn-add { background-color: #ec407a; color: white; margin-top: 10px; }
    .btn-delete {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ffcdd2;
      color: #c62828;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-weight: bold;
      cursor: pointer;
      line-height: 50px;
      text-align: center;
      font-size: 32px;
    }
    #loader, #modal-overlay, #success-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    #loader-content, #modal-content, #success-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 40px;
      border-radius: 8px;
      text-align: center;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      font-size: 35px;
    }
    #loader-message { font-size: 35px; }
    #modal-content h2, #success-modal-content h2 { font-size: 42px; color: #d81b60; }
    #confirmation-preview { text-align: left; }
    #confirmation-preview ol li { margin-bottom: 15px; }
    #image-preview, #confirmation-image-preview {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #success-modal-content p { text-align: left; line-height: 1.6; }
    #success-modal-content a { color: #d81b60; text-decoration: underline; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>aiko ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ </h1>
    <form id="setlist-form">

      <div class="section">
        <div class="section-title">ãƒ©ã‚¤ãƒ–æƒ…å ±</div>
        <select id="live-select" name="live-select" required>
          <option value="">-- èª­ã¿è¾¼ã¿ä¸­... --</option>
        </select>
        <div id="live-details" class="live-details" style="display: none;"></div>
      </div>

      <div class="section">
        <div class="section-title">æŠ•ç¨¿è€… (ä»»æ„)</div>
        <input type="text" id="submitter-name" placeholder="ãŠåå‰ã‚’å…¥åŠ›ã§ãã¾ã™">
      </div>

      <div class="section">
        <div class="section-title">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆæƒ…å ±</div>
        <div id="setlist-container"></div>
        <button type="button" class="btn btn-add" onclick="addSongEntry()">æ›²ã‚’è¿½åŠ </button>
      </div>

      <div class="section">
        <div class="section-title">ã‚»ãƒˆãƒªãƒœãƒ¼ãƒ‰ç”»åƒ (ä»»æ„)</div>
        <input type="file" id="image-file" accept="image/*">
        <canvas id="image-canvas" style="display:none;"></canvas>
        <img id="image-preview" style="display: none;">
      </div>

      <button type="button" class="btn btn-primary" onclick="showConfirmation()">ç¢ºèªç”»é¢ã¸é€²ã‚€</button>
    </form>
  </div>

  <template id="song-entry-template">
    <div class="song-entry">
      <button type="button" class="btn-delete" onclick="this.parentElement.remove()">Ã—</button>
      <select class="song-select">
        <option value="">-- æ›²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>
      <div class="checkbox-group">
        <label><span>ã“ã®æ›²ã¯ãƒ¡ãƒ‰ãƒ¬ãƒ¼ï¼Ÿ</span><input type="checkbox" class="is-medley"></label>
      </div>
      <div class="radio-group">
        <span class="radio-group-title">ã“ã®æ›²ã¯ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«</span>
        <label><input type="radio" name="encore-radio" value="none" checked><span>ã§ã¯ãªã„</span></label>
        <label><input type="radio" name="encore-radio" value="_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« #1"><span>ï¼‘å›ç›®</span></label>
        <label><input type="radio" name="encore-radio" value="_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« #2"><span>ï¼’å›ç›®</span></label>
        <label><input type="radio" name="encore-radio" value="_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« #3"><span>ï¼“å›ç›®</span></label>
        <label><input type="radio" name="encore-radio" value="_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« #4"><span>ï¼”å›ç›®</span></label>
        <label><input type="radio" name="encore-radio" value="_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« #5"><span>ï¼•å›ç›®</span></label>
      </div>
    </div>
  </template>

  <div id="loader"><div id="loader-content"><p id="loader-message">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div></div>
  <div id="modal-overlay">
    <div id="modal-content">
      <h2>å…¥åŠ›å†…å®¹ã®ç¢ºèª</h2>
      <div id="confirmation-preview"></div>
      <div style="margin-top: 20px;">
        <button type="button" class="btn btn-primary" id="submit-button" onclick="submitData()">ã“ã®å†…å®¹ã§æŠ•ç¨¿ã™ã‚‹</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ä¿®æ­£ã™ã‚‹</button>
      </div>
    </div>
  </div>
  <div id="success-modal-overlay">
    <div id="success-modal-content">
      <h2>æŠ•ç¨¿å®Œäº†</h2>
      <p id="success-message"></p>
      <button type="button" class="btn btn-primary" onclick="closeSuccessModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxmxttUQvjW6Gm3vCOdkjwwGbbfgADozI3MU869GGEFjRqLfo8ppPBz_F5F-_ShrY3c/exec";

    let sheetData = { liveInfo: [], songList: [] };

    window.addEventListener('load', function() {
      showLoader('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      fetchData();
      document.getElementById('image-file').addEventListener('change', handleImageUpload);
    });

    // ãƒ‡ãƒ¼ã‚¿ã®å–å¾— (fetch APIä½¿ç”¨)
    function fetchData() {
      fetch(GAS_API_URL)
        .then(response => response.json())
        .then(data => {
          sheetData = data;
          initializeForm();
        })
        .catch(error => {
          alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error);
          hideLoader();
        });
    }

    function initializeForm() {
      const liveSelect = document.getElementById('live-select');
      liveSelect.innerHTML = '<option value="">-- ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';

      sheetData.liveInfo.forEach((live, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = live.display;
        liveSelect.appendChild(option);
      });

      addSongEntry();
      hideLoader();
    }

    // ç”»åƒåœ§ç¸®ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            document.getElementById('image-preview').style.display = 'none';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.getElementById('image-canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 1000;
                const MAX_HEIGHT = 1000;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                } else {
                    if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                const preview = document.getElementById('image-preview');
                preview.src = canvas.toDataURL('image/jpeg', 0.7);
                preview.style.display = 'block';
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    // ãƒ©ã‚¤ãƒ–é¸æŠæ™‚ã®è©³ç´°è¡¨ç¤º
    document.getElementById('live-select').addEventListener('change', function() {
      const liveDetails = document.getElementById('live-details');
      if (this.value === "") {
        liveDetails.style.display = 'none';
        return;
      }
      const selectedLive = sheetData.liveInfo[this.value];
      liveDetails.textContent = `${selectedLive.region}ï¼š${selectedLive.venue}`;
      liveDetails.style.display = 'block';
    });

    // æ›²å…¥åŠ›æ¬„ã®è¿½åŠ 
    function addSongEntry() {
      const template = document.getElementById('song-entry-template');
      const clone = template.content.cloneNode(true);
      const songSelect = clone.querySelector('.song-select');
      
      sheetData.songList.forEach(song => {
        const option = document.createElement('option');
        option.value = song.title;
        option.textContent = song.title;
        songSelect.appendChild(option);
      });
      
      const uniqueName = 'encore-radio-' + Date.now() + Math.random();
      clone.querySelectorAll('input[name="encore-radio"]').forEach(radio => radio.name = uniqueName);
      
      document.getElementById('setlist-container').appendChild(clone);
    }

    // ç¢ºèªç”»é¢è¡¨ç¤º
    function showConfirmation() {
        const liveSelect = document.getElementById('live-select');
        if (liveSelect.value === "") { alert('é–‹å‚¬æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }

        const selectedLive = sheetData.liveInfo[liveSelect.value];
        let previewHtml = `<h3>ãƒ©ã‚¤ãƒ–æƒ…å ±</h3><p>${selectedLive.display}<br>${selectedLive.region}ï¼š${selectedLive.venue}</p>`;
        
        const submitter = document.getElementById('submitter-name').value;
        if (submitter) previewHtml += `<h3>æŠ•ç¨¿è€…</h3><p>${submitter}</p>`;

        previewHtml += '<h3>ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3><ol>';
        const songEntries = document.querySelectorAll('.song-entry');
        let hasSong = false;
        songEntries.forEach(entry => {
            const songTitle = entry.querySelector('.song-select').value;
            if (songTitle) {
                hasSong = true;
                const isMedley = entry.querySelector('.is-medley').checked ? ' (ãƒ¡ãƒ‰ãƒ¬ãƒ¼)' : '';
                const encoreRadio = entry.querySelector('input[name^="encore-radio"]:checked');
                const encoreLabel = encoreRadio.nextElementSibling.textContent;
                const encoreText = (encoreRadio.value !== 'none') ? ` (ã‚¢ãƒ³ã‚³ãƒ¼ãƒ« ${encoreLabel})` : '';
                previewHtml += `<li>${songTitle}${isMedley}${encoreText}</li>`;
            }
        });

        if (!hasSong) { alert('æ›²ã‚’1æ›²ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
        previewHtml += '</ol>';

        const imagePreview = document.getElementById('image-preview');
        if (imagePreview.style.display !== 'none') {
            previewHtml += `<h3>æ·»ä»˜ç”»åƒ</h3><img id="confirmation-image-preview" src="${imagePreview.src}">`;
        }

        document.getElementById('confirmation-preview').innerHTML = previewHtml;
        document.getElementById('modal-overlay').style.display = 'block';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ (POST)
    function submitData() {
        const submitBtn = document.getElementById('submit-button');
        submitBtn.disabled = true;
        submitBtn.textContent = 'æŠ•ç¨¿ä¸­...';
        showLoader('æŠ•ç¨¿ä¸­...');

        const liveIndex = document.getElementById('live-select').value;
        const formData = {
            liveInfo: sheetData.liveInfo[liveIndex],
            submitter: document.getElementById('submitter-name').value,
            songs: []
        };
        
        document.querySelectorAll('.song-entry').forEach(entry => {
            const title = entry.querySelector('.song-select').value;
            if (title) {
                formData.songs.push({
                    title: title,
                    isMedley: entry.querySelector('.is-medley').checked,
                    encore: entry.querySelector('input[name^="encore-radio"]:checked').value
                });
            }
        });
        
        const canvas = document.getElementById('image-canvas');
        if (canvas.width > 0 && document.getElementById('image-preview').style.display !== 'none') { 
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            const [header, data] = imageDataUrl.split(',');
            formData.imageData = {
                mimeType: header.match(/:(.*?);/)[1],
                data: data
            };
        }

        // fetchã§POSTé€ä¿¡ (ç‰¹æ®Šãªè¨­å®š: no-corsã§ã¯ãªãã€æˆ»ã‚Šå€¤ã‚’å—ã‘å–ã‚‹ãŸã‚ã«é€šå¸¸ã®POST)
        // GASå´ã§ContentServiceã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€redirect: 'follow' ãŒé‡è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒ
        // Beacon APIã‚„é€šå¸¸ã®POSTã§JSONã‚’é€ã‚Šã¾ã™ã€‚
        fetch(GAS_API_URL, {
          method: 'POST',
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(result => {
           if(result.status === 'success') {
             onSuccess(result.message);
           } else {
             throw new Error(result.message);
           }
        })
        .catch(error => {
           onFailure(error);
        });
    }

    function onFailure(error) {
        hideLoader();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        const submitBtn = document.getElementById('submit-button');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã“ã®å†…å®¹ã§æŠ•ç¨¿ã™ã‚‹';
    }
    
    function onSuccess(message) {
      closeModal();
      hideLoader();
      resetForm(); 
      const successMessageEl = document.getElementById('success-message');
      successMessageEl.innerHTML = 'æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br><br>çµæœã¯ç²¾æŸ»ã®ã†ãˆã€å¾Œæ—¥ã€<a href="https://x.com/noki_dochibi/status/1977296153512398850?s=46&t=M9RS39PWU4T9DrG7RpQmEA" target="_blank" rel="noopener noreferrer">Love Like Data Base</a>ã€ã«åæ˜ ã•ã›ã¦ã„ãŸã ãã¾ã™ğŸ˜Š';
      document.getElementById('success-modal-overlay').style.display = 'block';
    }
    
    function closeSuccessModal() { document.getElementById('success-modal-overlay').style.display = 'none'; }

    function resetForm() {
        const submitBtn = document.getElementById('submit-button');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã“ã®å†…å®¹ã§æŠ•ç¨¿ã™ã‚‹';
        document.getElementById('setlist-form').reset();
        document.getElementById('live-details').style.display = 'none';
        document.getElementById('image-preview').style.display = 'none';
        const canvas = document.getElementById('image-canvas');
        canvas.width = 0; canvas.height = 0; // canvasãƒªã‚»ãƒƒãƒˆ

        const container = document.getElementById('setlist-container');
        while (container.firstChild) container.removeChild(container.firstChild);
        addSongEntry();
    }

    function showLoader(message) {
      document.getElementById('loader-message').textContent = message;
      document.getElementById('loader').style.display = 'block';
    }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
  </script>
</body>
</html>
